<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Page Title</title>
    <style>
        /* Inline CSS styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }
        h1 {
            color: #007BFF;
        }
        .score {
            width: 50%;
            height: 80%;
            min-width: 200px;
            min-height: 200px;
            resize: both;
            overflow: auto;
            border: 1px solid #333;
            display: flex;
            flex-wrap: wrap;
        }
        .bar {
            height: 32px;
            width: 128px;
            background-color: #007BFF;
            margin: 2px;
            cursor: move; /* Change cursor to indicate draggable */
            display: flex;
            position: relative; /* For positioning the number */
            white-space: nowrap; /* Prevent text from wrapping */
            overflow: visible; /* Allow overflowing text to be visible */
        }
        .selected {
            background-color: lightcoral; /* Light red color for selected bars */
        }
        .number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 12px;
            color: white; /* Color for the number */
        }
        .beat {
            flex: 1; /* Equal size for all beat divs */
            margin-left: 5px; /* Small margin for the number */
            display: flex;
            align-items: center; /* Center text vertically */
            justify-content: center; /* Center text horizontally */
            border: 1px solid black; /* Optional: border for visual separation */
            
        }
        .edit-input {
            height: 100%; /* Full height of the beat div */
            width: 90%; /* Slightly less than full width */
            border: none;
            padding: 0;
            margin: 0;
            font-size: 16px;
            text-align: center;
        }
    </style>
    <script>
        let lastSelectedIndex = -1;
        // Inline JavaScript

        document.addEventListener('DOMContentLoaded', function() {
            const barsContainer = document.querySelector('.score');

            function updateNumbers() {
                const bars = document.querySelectorAll('.bar');
                bars.forEach((bar, index) => {
                    const numberElement = bar.querySelector('.number');
                    if (numberElement) {
                        numberElement.innerText = index + 1; // Update the number
                    } else {
                        const newNumberElement = document.createElement('div');
                        newNumberElement.className = 'number';
                        newNumberElement.innerText = index + 1; // Set the number
                        bar.appendChild(newNumberElement);
                    }
                });
            }

            for (let i = 0; i < 8; i++) {
                bar = createBar();
                barsContainer.appendChild(bar);
            }

            updateNumbers(); // Initial numbering


            // Event listener for deleting selected bars
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    const selectedBars = document.querySelectorAll('.bar.selected');
                    selectedBars.forEach(selectedBar => {
                        selectedBar.remove();
                    });
                    updateNumbers(); // Update numbering after deletion
                } else if (e.key === '+') {
                    const selectedBars = document.querySelectorAll('.bar.selected');
                    const newBar = createBar();

                    if (selectedBars.length > 0) {
                        const lastSelectedBar = selectedBars[selectedBars.length - 1];
                        lastSelectedBar.parentNode.insertBefore(newBar, lastSelectedBar.nextSibling);
                    } else {
                        const scoreDiv = document.querySelector('.score');
                        scoreDiv.insertBefore(newBar, scoreDiv.firstChild); // Add before all other bars
                    }
                    updateNumbers(); // Update numbering after addition
                } else if (e.key === 'ArrowRight') { // Add this block for moving selected bars forward
                    let selectedBars = document.querySelectorAll('.bar.selected');
                    selectedBars = Array.from(selectedBars).reverse();
                    selectedBars.forEach(selectedBar => {
                        if(!selectedBar.previousElementSibling ||!selectedBar.previousElementSibling.classList.contains('selected')){    
                            let nextBar = selectedBar.nextElementSibling;
                            while(nextBar && nextBar.classList.contains('selected')){
                                nextBar = nextBar.nextElementSibling;
                            }
                            if (nextBar && nextBar.classList.contains('bar')) {
                                selectedBar.parentNode.insertBefore(nextBar, selectedBar); // Move next bar before the selected bar
                            }
                        }
                    });
                    updateNumbers(); // Update numbering after moving
                 } else if (e.key === 'ArrowLeft') { // Move selected bars backward
                    const selectedBars = Array.from(document.querySelectorAll('.bar.selected'));
                    if (selectedBars.length > 0) {
                        let firstSelectedBar = selectedBars[0];
                        let previousBar = firstSelectedBar.previousElementSibling;

                        if (previousBar && previousBar.classList.contains('bar')) {
                            selectedBars.forEach(selectedBar => {
                                previousBar = selectedBar.previousElementSibling;
                                const parent = selectedBar.parentNode;
                                parent.insertBefore(selectedBar, previousBar); // Move each selected bar before the previous bar
                            });
                            updateNumbers(); // Update numbering after moving
                        }
                    }
                } else if (e.key === 'Enter') { // Open the first selected element for editing
                    console.log("enter in score");
                   
                }
            });
        });

        function createBar(){
            const bar = document.createElement('div');
                bar.className = 'bar';
                bar.innerHTML = `<div class="number"></div>
                                 <div class="beat" contenteditable="true"></div>
                                 <div class="beat" contenteditable="true"></div>
                                 <div class="beat" contenteditable="true"></div>
                                 <div class="beat" contenteditable="true"></div>`; // Create number and beat divs
                                 bar.setAttribute('draggable', true);

            bar.addEventListener('dragstart', (e) => {
                const selectedBars = document.querySelectorAll('.bar.selected');
                const selectedTexts = Array.from(selectedBars).map(selectedBar => {
                    return Array.from(selectedBar.querySelectorAll('.beat')).map(beat => beat.innerText).join(', ');
                });
                e.dataTransfer.setData('text/plain', JSON.stringify(selectedTexts));
                e.dataTransfer.effectAllowed = 'move';
            });

            bar.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allow drop
            });

            bar.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedTexts = JSON.parse(e.dataTransfer.getData('text/plain'));
                let target = e.target;
                if(!target.classList.contains('bar')){
                    target = target.parentNode;
                }
                console.log(target);
                if (target.classList.contains('bar')) {
                    const parent = target.parentNode;
                    const targetIndex = Array.from(parent.children).indexOf(target);
                    const selectedBars = Array.from(parent.querySelectorAll('.bar.selected'));

                    // Insert dragged elements in the order they were selected
                    /*DO NOT CHANGE THIS CODE*/
                    selectedBars.forEach(draggedElement => {
                        console.log(draggedElement);
                        parent.insertBefore(draggedElement, target);
                    });
                    /* END DO NOT CHANGE THIS CODE*/

                    updateNumbers(); // Update numberinshg after drop
                }
            });

            bar.addEventListener('click', (e) => {
                if (e.shiftKey && lastSelectedIndex !== -1) {
                    // Select range of bars
                    const bars = document.querySelectorAll('.bar');
                    const currentIndex = Array.from(bars).indexOf(bar);
                    const start = Math.min(lastSelectedIndex, currentIndex);
                    const end = Math.max(lastSelectedIndex, currentIndex);
                    for (let i = start; i <= end; i++) {
                        bars[i].classList.add('selected');
                    }
                } else {
                    // Toggle selection of the clicked bar
                    bar.classList.toggle('selected');
                }
                lastSelectedIndex = Array.from(document.querySelectorAll('.bar')).indexOf(bar); // Update last selected index
            });

            // Add event listener for the beat divs
            const beats = bar.querySelectorAll('.beat');
            beats.forEach(beat => {
                beat.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete' || e.key === 'Backspace' ||  e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        e.stopPropagation(); // Prevent the event from bubbling up
                    }
                });
            });
            return bar;
        }
    </script>
</head>
<body>
    <h1>Welcome to Your Page</h1>
    <p>This is a basic HTML structure.</p>
    <div class="score">
        <!-- Bar elements will be dynamically created in JavaScript -->
    </div>
    <!-- Add your content here -->
</body>
</html>
